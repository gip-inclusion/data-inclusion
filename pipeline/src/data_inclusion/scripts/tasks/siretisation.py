import logging
import textwrap
from pathlib import Path
from typing import Optional

import pandas as pd
import sqlalchemy as sqla
from sqlalchemy import exc as sqla_exc
from sqlalchemy.engine import Engine
from tqdm import tqdm

from data_inclusion.schema import models
from data_inclusion.scripts.tasks import utils

logger = logging.getLogger(__name__)

tqdm.pandas()

DIR = Path(__file__).parent


NEAREST_ESTABLISHMENTS_STMT = sqla.text(
    textwrap.dedent(
        """
-- 1. filter out etablissements farther than 1km
CREATE TEMP TABLE structures_with_similarities AS
WITH etablissement_within_radius AS (SELECT siret
    FROM sirene_etablissement_geocode
    WHERE ST_DWITHIN(
        ST_SETSRID(ST_MAKEPOINT(:longitude, :latitude)::geography, 4326),
        geometry::geography,
        1000)
),

-- 2. enhance with searchable fields
etablissement_with_searchable_fields AS (SELECT
    etablissement_within_radius.siret,
    sirene_etablissement_searchable_name.searchable_name,
    sirene_etablissement_searchable_l4.searchable_l4
    FROM etablissement_within_radius
    INNER JOIN sirene_etablissement_searchable_name
        ON etablissement_within_radius.siret
           = sirene_etablissement_searchable_name.siret
    INNER JOIN sirene_etablissement_searchable_l4
        ON etablissement_within_radius.siret
           = sirene_etablissement_searchable_l4.siret
),

-- 3. compute similarity scores
structures_with_similarities AS (SELECT
    siret,
    searchable_l4,
    searchable_name,
    SIMILARITY(
        searchable_l4, :normalized_address_str
    ) AS l4_similarity,
    SIMILARITY(
        searchable_name, :normalized_name_str
    ) AS name_similarity
    FROM etablissement_with_searchable_fields
    WHERE
        searchable_name % :normalized_name_str
        OR searchable_l4 % :normalized_address_str
)

-- 4. materialized results to speed up next WHERE clause
SELECT * FROM structures_with_similarities;

-- 5. compute score and get highest
SELECT
    siret,
    searchable_l4,
    searchable_name,
    (COALESCE(l4_similarity, 0) + 2 * COALESCE(name_similarity, 0)) / 3 AS score
FROM structures_with_similarities
WHERE
    name_similarity > 0.3
    AND l4_similarity > 0.3
ORDER BY 4 DESC
LIMIT 1;

"""
    )
)


def search_establishment_by_similarities(
    engine: Engine,
    nom: Optional[str] = None,
    adresse: Optional[str] = None,
    latitude: Optional[float] = None,
    longitude: Optional[float] = None,
) -> Optional[dict]:

    if nom is None or adresse is None or latitude is None or longitude is None:
        logger.debug("Missing data")
        return None

    with engine.connect() as conn:
        try:
            establishments_list = conn.execute(
                NEAREST_ESTABLISHMENTS_STMT,
                {
                    "normalized_name_str": nom.replace("'", " "),
                    "normalized_address_str": adresse.replace("'", " "),
                    "latitude": latitude,
                    "longitude": longitude,
                },
            ).all()
        except sqla_exc.DataError as exc:
            logger.error(exc)
            return None

    if len(establishments_list) == 0:
        logger.debug("No matching establishment")
        return None

    return dict(establishments_list[0])


SEARCH_MUNI_STMT = sqla.text(
    textwrap.dedent(
        """
-- 1. filter for active entreprises with categorie juridique of interest
WITH entreprise_filtered AS (SELECT
    siren,
    "nicSiegeUniteLegale"
    FROM sirene_stock_unite_legale
    WHERE "etatAdministratifUniteLegale" = 'A'
        AND "categorieJuridiqueUniteLegale" IN ('7210', '7313', '7312')
),

-- 2. get the associated etablishments within 10km and with activity of interest
etablissement_filtered AS (
    SELECT sirene_etablissement_geocode.*
    FROM sirene_etablissement_geocode
    INNER JOIN entreprise_filtered
        ON
            LEFT(
                sirene_etablissement_geocode.siret, 9
            ) = entreprise_filtered.siren
    WHERE
        ST_DWITHIN(
            ST_SETSRID(ST_MAKEPOINT(:longitude, :latitude)::geography, 4326),
            sirene_etablissement_geocode.geometry::geography,
            10000
        )
        AND sirene_etablissement_geocode."activitePrincipaleEtablissement"
        = '84.11Z'
),

-- 3. enhance with searchable fields
etablissement_with_searchable_fields AS (SELECT
    etablissement_filtered.siret,
    sirene_etablissement_searchable_name.searchable_name
    FROM etablissement_filtered
    INNER JOIN sirene_etablissement_searchable_name
        ON etablissement_filtered.siret
           = sirene_etablissement_searchable_name.siret
),

-- 4. annotate with similarity
etablissement_with_similarities AS (
    SELECT
        siret,
        WORD_SIMILARITY(searchable_name, :normalized_commune_str) AS name_similarity
    FROM etablissement_with_searchable_fields
)

-- 3. compute score and get highest
SELECT *
FROM etablissement_with_similarities
ORDER BY name_similarity DESC;
"""
    )
)


def search_municipality(
    engine: Engine,
    commune: Optional[str] = None,
    latitude: Optional[float] = None,
    longitude: Optional[float] = None,
):
    if commune is None or latitude is None or longitude is None:
        logger.debug("Missing data")
        return None

    with engine.connect() as conn:
        try:
            establishments_list = conn.execute(
                SEARCH_MUNI_STMT,
                {
                    "normalized_commune_str": commune.replace("'", " "),
                    "latitude": latitude,
                    "longitude": longitude,
                },
            ).all()
        except sqla_exc.DataError as exc:
            logger.error(exc)
            return None

    if len(establishments_list) == 0:
        logger.debug("No matching establishment")
        return None

    return dict(establishments_list[0])


def search_establishment(
    engine: Engine,
    source: str,
    id_: str,
    commune: Optional[str] = None,
    nom: Optional[str] = None,
    adresse: Optional[str] = None,
    latitude: Optional[float] = None,
    longitude: Optional[float] = None,
    typologie: Optional[models.Typologie] = None,
):
    if source == "odspep" and id_ in SIRET_BY_ODSPEP_ID:
        return {
            "siret": SIRET_BY_ODSPEP_ID[id_][0],
            "antenne": SIRET_BY_ODSPEP_ID[id_][1],
        }
    elif source == "mes-aides" and id_ in SIRET_BY_MES_AIDES_ID:
        return {"siret": SIRET_BY_MES_AIDES_ID[id_]}

    if typologie == models.Typologie.MUNI:
        return search_municipality(
            commune=commune,
            latitude=latitude,
            longitude=longitude,
            engine=engine,
        )

    return search_establishment_by_similarities(
        nom=nom,
        adresse=adresse,
        latitude=latitude,
        longitude=longitude,
        engine=engine,
    )


def siretize_normalized_dataframe(
    structures_df: pd.DataFrame,
    sirene_database_url: str,
) -> pd.DataFrame:
    utils.log_df_info(structures_df, logger)

    engine = sqla.create_engine(sirene_database_url)

    def get_typologie(value: Optional[str]) -> Optional[models.Typologie]:
        if value is None:
            return None
        return next(
            (typologie for typologie in models.Typologie if typologie.value == value),
            None,
        )

    establishments_df = structures_df.progress_apply(
        lambda row: search_establishment(
            engine=engine,
            source=row.source,
            id_=row.id,
            nom=row.nom,
            adresse=row.adresse,
            latitude=row.latitude,
            longitude=row.longitude,
            commune=row.commune,
            typologie=get_typologie(row.typologie),
        )
        or {"siret": None},
        axis="columns",
        result_type="expand",
    )

    output_df = structures_df
    output_df = output_df.assign(siret=establishments_df.siret)
    output_df = output_df.assign(
        antenne=establishments_df.antenne if "antenne" in establishments_df else None
    )

    utils.log_df_info(output_df, logger)

    return output_df


SIRET_BY_ODSPEP_ID = {
    "1403": ("50772037300012", False),
    "1413": ("87849592800029", True),
    "1415": ("31463536800058", False),
    "1418": ("26974019700018", False),
    "1439": ("31463536800058", False),
    "1446": ("44288485400047", False),
    "1447": ("42866415500044", False),
    "15499": ("77567227229164", False),
    "15503": ("53831978100026", False),
    "15504": ("18001004300016", False),
    "15507": ("33806915600028", False),
    "15511": ("35252709700013", False),
    "15513": ("50792651700040", False),
    "15514": ("39988720700039", False),
    "15516": ("17202001800013", True),
    "15529": ("31107786100053", False),
    "15535": ("78299313300027", True),
    "15539": ("32739815200022", True),
    "15540": ("32739815200022", True),
    "15555": ("13002077900018", False),
    "15560": ("32739815200022", False),
    "15564": ("32856536100057", False),
    "15565": ("53881496300012", False),
    "15576": ("27200002700024", False),
    "15578": ("05881167000031", False),
    "15579": ("06080477000091", False),
    "15583": ("38954831400118", False),
    "15584": ("42067491300025", False),
    "15587": ("33038493400023", False),
    "15588": ("40419362500021", False),
    "15589": ("33848916400065", False),
    "15592": ("78050391800044", False),
    "15595": ("41051615700626", False),
    "15603": ("13002871500014", False),
    "15605": ("13002871500014", False),
    "15607": ("13000799000026", False),
    "15611": ("13002871500014", False),
    "15617": ("78300567100038", True),
    "15625": ("78300567100020", True),
    "15627": ("26200009400017", False),
    "15631": ("26200009400173", False),
    "15638": ("13002379900013", False),
    "15639": ("77568873207561", False),
    "15641": ("41051615700022", True),
    "15654": ("79107985800779", False),
    "15656": ("50910992200039", False),
    "15658": ("52849964300013", False),
    "15670": ("20007695800210", False),
    "15678": ("20007695800145", False),
    "15680": ("20007695800228", False),
    "15682": ("53324538700022", False),
    "15687": ("75282922600014", False),
    "15699": ("79314685300015", False),
    "15714": ("52330267700035", False),
    "15728": ("38755041100038", False),
    "15731": ("42113224200015", False),
    "15737": ("20007695800210", False),
    "15741": ("20007695800012", True),
    "15749": ("21200033500019", False),
    "15803": ("40841915800014", False),
    "15807": ("32739815200022", True),
    "15809": ("26202068800012", False),
    "15811": ("21200030100011", True),
    "15812": ("26200003700016", False),
    "15814": ("21200036800010", True),
    "15816": ("26202013400017", False),
    "15820": ("21200046700010", True),
    "15824": ("21200055800016", True),
    "15833": ("26202038100014", False),
    "15841": ("21200107700016", True),
    "15842": ("26202015900014", False),
    "15843": ("26202069600015", False),
    "15844": ("26200014400028", False),
    "15845": ("21200148100010", True),
    "15846": ("26202080300017", False),
    "15847": ("26202056300017", False),
    "15848": ("21200159800011", False),
    "15850": ("21200166300013", True),
    "15852": ("26202050600016", False),
    "15853": ("21200170500012", True),
    "15854": ("26202078700012", False),
    "15857": ("21200195200010", True),
    "15860": ("21200206700016", True),
    "15861": ("26202079500015", False),
    "15862": ("21200224000019", True),
    "15864": ("21200233100016", True),
    "15865": ("26202005000015", False),
    "15866": ("21200236400017", True),
    "15867": ("21200250500015", True),
    "15868": ("21200251300019", True),
    "15869": ("21200261200019", True),
    "15870": ("26202053000016", False),
    "15871": ("21200309900067", False),
    "15872": ("21200274500017", True),
    "15873": ("26202051400010", False),
    "15876": ("21200327100013", True),
    "15877": ("26202021700010", False),
    "15878": ("21200350300019", True),
    "15880": ("21200355200016", True),
    "17211": ("45201044000017", False),
    "17212": ("77567227206469", False),
    "17215": ("77566669600841", False),
    "17221": ("78299313300027", False),
    "17222": ("78299313300027", True),
    "17223": ("78299313300027", True),
    "17232": ("78299313300027", False),
    "17233": ("40897543100011", False),
    "17234": ("39208404200028", False),
    "17235": ("19201002300021", False),
    "17239": ("38905630000053", False),
    "17247": ("31079260100026", False),
    "17248": ("57210489102498", False),
    "17252": ("18201924000023", False),
    "17258": ("41412726600040", False),
    "17262": ("39208452100021", False),
    "17263": ("82509414700014", False),
    "17265": ("30666371700222", True),
    "17269": ("21200004600012", True),
    "17270": ("83942400900018", False),
    "17271": ("30752508900024", False),
    "17281": ("05881167000098", True),
    "17282": ("39326664800012", False),
    "17283": ("27200001900039", False),
    "17284": ("78299313300027", False),
    "17290": ("21200004600418", False),
    "17292": ("21200004600400", False),
    "17293": ("21200004600012", True),
    "17304": ("20007695800319", False),
    "17307": ("20007695800335", False),
    "17342": ("18201924000015", False),
    "17344": ("53373558500028", False),
    "17354": ("38369629100020", True),
    "17359": ("41225908700028", False),
    "17361": ("41051615700758", False),
    "17362": ("41051615700758", False),
    "17364": ("26200008600245", False),
    "17367": ("26200008600153", False),
    "17368": ("32101874900408", False),
    "17374": ("40219888100037", False),
    "17375": ("13002379900021", False),
    "17379": ("35221687301938", False),
    "17380": ("31079260100026", False),
    "17381": ("48432793700039", False),
    "17383": ("48432793700021", False),
    "17931": ("33140764300021", False),
    "18225": ("26310123000260", False),
    "18226": ("52994177500015", False),
    "18228": ("26310123000070", False),
    "18233": ("83130584200013", False),
    "18234": ("35225930300043", False),
    "18235": ("40299109500025", False),
    "18236": ("33214960800025", False),
    "18237": ("37980933800013", False),
    "18238": ("42862562800022", False),
    "18239": ("39854810700042", False),
    "18240": ("37998641700036", False),
    "18241": ("44012166300023", False),
    "18242": ("43831829700027", False),
    "18244": ("39269993000039", False),
    "18264": ("43480625300010", False),
    "1850": ("54004030000027", False),
    "18522": ("22080004900573", False),
    "18523": ("22080004900185", False),
    "18524": ("22080004900540", False),
    "18525": ("22080004900557", True),
    "18526": ("22080004900011", True),
    "18527": ("22080004900581", False),
    "18528": ("22080004900565", True),
    "18529": ("22080004900532", False),
    "18530": ("22080004900201", False),
    "18531": ("22080004900235", False),
    "18532": ("22080004900219", False),
    "18534": ("22080004900227", False),
    "18551": ("22080004900227", False),
    "18553": ("22080004900193", False),
    "18554": ("22080004900581", False),
    "18555": ("22080004900219", False),
    "18556": ("22080004900193", False),
    "18557": ("22080004900193", False),
    "18558": ("22080004900185", False),
    "18560": ("22080004900557", True),
    "18561": ("22080004900235", False),
    "18562": ("22080004900201", False),
    "1858": ("49025097400022", False),
    "1859": ("54004030000027", False),
    "1867": ("22080004900011", True),
    "1868": ("35092344700022", False),
    "1869": ("22080004900011", True),
    "18676": ("22080004900565", False),
    "18689": ("22080004900011", True),
    "18692": ("22080004900581", False),
    "18694": ("22080004900540", False),
    "1870": ("57210489101847", False),
    "18701": ("22080004900532", False),
    "18702": ("22080004900193", False),
    "18707": ("22080004900185", False),
    "18709": ("22080004900557", True),
    "1871": ("22080004900011", True),
    "18710": ("22080004900235", True),
    "18711": ("22080004900201", False),
    "18714": ("22080004900227", False),
    "18716": ("22080004900565", False),
    "18718": ("22080004900011", True),
    "18719": ("22080004900581", False),
    "1872": ("22080004900011", True),
    "18721": ("22080004900540", False),
    "18724": ("22080004900532", False),
    "18726": ("22080004900193", False),
    "18728": ("22080004900185", False),
    "1873": ("22080004900011", True),
    "18733": ("22080004900557", True),
    "18735": ("22080004900235", False),
    "18738": ("22080004900201", False),
    "1874": ("22080004900011", True),
    "18741": ("22080004900227", False),
    "18748": ("13002801200099", False),
    "18749": ("13002801200099", False),
    "1875": ("26080093300145", False),
    "18750": ("22080004900565", False),
    "18751": ("22080004900011", True),
    "18752": ("22080004900581", False),
    "18753": ("22080004900540", False),
    "18754": ("22080004900219", False),
    "18759": ("22080004900532", False),
    "1876": ("50340778500024", False),
    "18760": ("22080004900193", False),
    "1877": ("22080004900581", False),
    "1878": ("22080004900011", True),
    "1879": ("22080004900011", True),
    "1880": ("22080004900011", True),
    "1881": ("22080004900565", False),
    "1882": ("22080004900565", False),
    "1883": ("22080004900011", True),
    "1885": ("77555396900061", False),
    "1886": ("89839516500019", False),
    "1887": ("77555396900061", False),
    "1888": ("77555396900061", False),
    "1889": ("77555396900061", False),
    "1890": ("22080004900011", True),
    "1891": ("48338835100031", False),
    "1892": ("48338835100031", False),
    "1893": ("51054826600038", False),
    "1894": ("49025097400022", False),
    "1896": ("26080093300145", False),
    "19434": ("77566669602730", True),
    "19438": ("77566669602730", True),
    "19491": ("42509707800041", True),
    "19668": ("77693923300016", False),
    "19677": ("44831976400032", False),
    "19884": ("51183880700010", False),
    "19886": ("31349910500010", False),
    "20512": ("77774934200146", False),
    "22838": ("77567223100955", False),
    "22841": ("77567223100955", False),
    "46314": ("20004315600146", True),
    "46395": ("57210489103595", False),
    "46413": ("18590018000026", True),
    "46414": ("18590018000026", True),
    "46415": ("18590018000026", True),
    "46463": ("18590018000026", True),
    "46486": ("20007351800017", False),
    "46488": ("21600186700011", False),
    "46492": ("21600330100019", False),
    "46494": ("21600340000019", False),
    "46497": ("22600001600403", True),
    "46505": ("39293616700031", False),
    "46506": ("52592031000030", False),
    "46507": ("78050391800044", False),
    "46508": ("52592031000030", False),
    "46511": ("77554716900380", False),
    "46514": ("32102946400112", False),
    "46515": ("21600585000013", False),
    "46516": ("21600607200013", False),
    "46518": ("21600617100013", False),
    "46522": ("18590018000026", True),
    "46524": ("30474783500581", False),
    "46526": ("77567626500041", False),
    "46529": ("24600091300052", True),
    "46539": ("18590018000026", True),
    "46540": ("18590018000026", True),
    "46574": ("26600501600016", False),
    "46612": ("31021419200034", False),
    "46619": ("35221687302282", False),
    "46623": ("26600026400017", False),
    "46670": ("78050825500095", False),
    "46671": ("77562808400052", False),
    "46672": ("77566008703421", False),
    "46673": ("78436122200010", True),
    "46674": ("31341315500059", False),
    "46675": ("26600711100658", False),
    "46676": ("26600711100443", False),
    "46677": ("26600711100344", False),
    "46678": ("51739018300013", False),
    "46679": ("26600697200183", True),
    "46732": ("77568030900025", False),
    "46734": ("26600711100393", False),
    "46735": ("26600711100500", False),
    "46737": ("40428957100030", True),
    "46739": ("40428957100030", True),
    "46847": ("77566669601922", False),
    "46848": ("79978444200011", False),
    "46851": ("77568873207389", False),
    "46855": ("77566008703421", False),
    "46857": ("26600057900018", False),
    "46865": ("26600086800015", False),
    "46866": ("26600139500018", False),
    "46867": ("21600257600017", True),
    "46868": ("26600447200012", False),
    "46898": ("26600143700018", False),
    "47612": ("18590018000026", True),
    "47613": ("21600012500098", True),
    "47616": ("78050391800044", False),
    "47621": ("20005380900014", False),
    "47623": ("26600393800047", False),
    "47624": ("40428957100030", True),
    "47627": ("77566669601641", True),
    "47629": ("77567227216914", False),
    "47666": ("37974546600324", False),
    "47744": ("24600075600162", True),
    "47745": ("42509175800010", True),
    "47746": ("24600085500055", True),
    "47817": ("75383311000012", False),
    "47818": ("34911325800033", False),
    "47819": ("40798664500023", False),
    "47836": ("41192182800041", False),
    "47838": ("53422461300065", False),
    "47842": ("40428957100030", True),
    "47843": ("40428957100030", True),
    "47845": ("77566669601641", False),
    "47846": ("77566669601641", False),
    "47848": ("77567227211170", False),
    "47849": ("83376076200017", False),
    "47948": ("42509146900014", False),
    "47950": ("80015764600012", False),
    "47951": ("42509175800010", False),
    "47952": ("34911325800033", False),
    "47954": ("26600159300018", False),
    "47955": ("18590018000026", True),
    "47958": ("39448622900146", False),
    "47960": ("26600151000012", False),
    "47962": ("53422461300040", False),
    "47963": ("77566008701979", False),
    "47964": ("40428957100030", True),
    "47965": ("40428957100030", True),
    "47966": ("78050829700105", True),
    "48034": ("26600188200015", False),
    "48043": ("53517960000023", True),
    "48046": ("49260529000013", False),
    "48047": ("41033527700043", False),
    "48117": ("13002830100013", True),
    "48118": ("43381119700030", False),
    "48119": ("20006796500018", True),
    "48120": ("49134913000014", False),
    "48121": ("78050821400068", False),
    "48122": ("50217593800047", False),
    "48315": ("78805803000495", False),
    "48318": ("81762382000013", False),
    "48319": ("77566669600015", True),
    "48321": ("77568030900298", False),
    "48322": ("78050824800025", False),
    "48325": ("77568030900306", False),
    "48326": ("30169114300392", False),
    "48327": ("31341315500141", False),
    "48329": ("21600627000013", True),
    "48330": ("77562852200127", False),
    "48331": ("77568030900306", False),
    "48332": ("26600711100419", False),
    "48333": ("77568030903672", False),
    "48334": ("77562808400078", False),
    "48336": ("40428957100030", True),
    "48336": ("40428957100030", True),
    "48338": ("53277827100025", False),
    "48339": ("26600466200042", False),
    "48340": ("78056175900017", False),
    "48341": ("26600711100427", True),
    "48342": ("77567227215973", False),
    "48343": ("77562849800021", False),
    "48345": ("77568030900280", False),
    "48346": ("42922920600017", False),
    "48348": ("77567227223712", False),
    "48351": ("41756109900025", False),
    "48353": ("77562849800021", False),
    "48356": ("40428957100030", True),
    "48357": ("32055236700064", False),
    "48358": ("38335461000032", True),
    "48360": ("45332633200039", True),
    "48362": ("41843581400102", False),
    "48364": ("38335461000032", False),
    "48365": ("77567227221955", False),
    "48370": ("80220198800010", False),
    "48373": ("47849566600016", False),
    "48374": ("77567227215981", False),
    "48376": ("45332633200039", True),
    "48377": ("77562849800021", False),
    "48378": ("26600414200011", False),
    "48380": ("77562852200226", False),
    "48381": ("78481011100152", False),
    "48409": ("49817569400039", False),
    "48414": ("21600465500017", True),
    "48420": ("21600410100012", True),
    "48630": ("32387385100022", False),
    "48631": ("48060276200027", False),
    "48633": ("53361536500038", False),
    "48634": ("78050829700105", False),
    "48635": ("48353113300021", False),
    "48637": ("53336985600026", False),
    "48638": ("77562803500351", False),
    "49384": ("33983901100048", False),
    "49386": ("26600381300018", False),
    "49390": ("77554716900331", False),
    "49409": ("45340899900010", False),
    "49410": ("75311595500027", False),
    "49411": ("20003495700031", False),
    "49524": ("75098856000017", False),
    "49525": ("78839519200024", False),
    "49526": ("77562803500179", False),
    "49528": ("26600057900083", False),
    "49529": ("18003402701225", False),
    "49532": ("78481011100152", False),
    "49533": ("33962208600025", False),
    "49534": ("40798664500023", False),
    "49550": ("24600084800019", True),
    "49551": ("21600283200014", True),
    "49556": ("21600104000015", True),
    "49611": ("83376076200017", True),
    "49637": ("20003465000065", False),
    "49642": ("40118706700038", False),
    "49643": ("40118706700038", False),
    "49648": ("40118706700038", False),
    "49649": ("83887490700010", False),
    "49652": ("24600089700024", True),
    "49653": ("24600074900076", True),
    "49654": ("79287887800026", False),
    "49655": ("48768720400015", False),
    "49657": ("82124352400013", False),
    "49658": ("82517842900015", False),
    "49660": ("78052721400016", True),
    "49661": ("21600158600017", True),
    "49663": ("78052723000012", True),
    "49667": ("30047465700032", False),
    "49669": ("38323180000038", False),
    "49671": ("21600379800073", False),
    "49673": ("52813947000025", False),
    "49678": ("21600335000016", True),
    "49681": ("52857022901763", False),
    "49682": ("30047465700032", False),
    "49689": ("77567227215205", False),
    "49690": ("21600158600595", False),
    "49694": ("21600158600587", False),
    "49696": ("21600158600454", False),
    "49699": ("21600158600017", True),
    "49710": ("77568030900033", False),
    "49742": ("22974001400829", False),
    "49759": ("80771201300018", False),
    "49760": ("24600070700090", True),
    "49761": ("42509147700017", False),
    "49765": ("24600092100097", False),
    "49767": ("20006697500018", False),
    "49781": ("21600219600014", True),
    "49788": ("78050825500046", False),
    "49789": ("53928851400026", True),
    "49808": ("78050391800028", False),
    "49809": ("78050391800028", True),
    "49810": ("78050391800044", True),
    "49812": ("78050825500053", False),
    "49813": ("43757777800073", True),
    "49814": ("78050825500095", False),
    "49858": ("18590018000026", True),
    "49944": ("81766523500039", True),
    "49952": ("78053394900027", False),
    "49953": ("81979607900013", False),
    "49958": ("49477374000050", True),
    "49959": ("49916209700061", True),
    "49960": ("50242420300037", False),
    "49962": ("78057792000058", False),
    "49963": ("53927440700011", False),
    "50132": ("78050829700113", False),
    "50138": ("26600116300010", False),
    "50140": ("39877218600118", False),
    "50143": ("26600708700015", True),
    "50148": ("20005374200017", True),
    "50149": ("57201545100162", False),
    "50151": ("38758193700035", False),
    "50167": ("38758193700035", False),
    "50169": ("38758193700035", True),
    "50171": ("78050391800044", True),
    "50172": ("78050391800044", True),
    "50178": ("38039115100012", True),
    "5233": ("34995887600246", False),
    "53057": ("40021700600032", False),
    "53058": ("80400660900031", True),
    "53113": ("83819653300015", False),
    "53182": ("82847464300016", False),
    "53188": ("44021185200031", False),
    "53256": ("37748708700019", False),
    "53257": ("50858225100023", False),
    "53300": ("42329419800100", False),
    "53309": ("26974018900023", False),
    "53450": ("35143449300018", False),
    "53451": ("81415020700029", False),
    "53452": ("52404337900014", False),
    "53453": ("83121356600019", False),
    "53458": ("87827914000023", False),
    "53464": ("79120882000021", False),
    "53473": ("43792531600030", False),
    "53637": ("35221687300823", False),
    "53638": ("35221687300831", False),
    "53640": ("49552008200027", False),
    "53641": ("52015225700025", False),
    "53642": ("31107786100053", False),
    "53653": ("21200033500019", True),
    "53654": ("78805803005122", False),
    "53656": ("13000799000018", False),
    "53662": ("32739815200022", False),
    "53665": ("41051615700758", True),
    "53666": ("13002379900013", False),
    "53667": ("31732867200041", False),
    "53741": ("77566008703553", False),
    "53861": ("31627883700109", False),
    "53863": ("33806915600028", False),
    "53881": ("21200033500019", True),
    "53888": ("20007695800202", False),
    "53889": ("31079260100026", False),
    "54005": ("52886246900038", False),
    "54011": ("77569338501804", False),
    "54012": ("77569338501804", False),
    "54022": ("77768390500023", False),
    "54401": ("77567223101490", False),
    "54505": ("79773970300016", False),
    "54599": ("41228073705467", False),
    "54603": ("85200519800027", False),
    "54604": ("44021185200031", False),
    "54605": ("26350077900016", False),
    "54756": ("42044985200037", False),
    "54775": ("81216222000014", False),
    "54776": ("31958329000014", False),
    "54881": ("79017389200031", False),
    "55042": ("34528201600202", False),
    "7378": ("82454114801368", True),
    "7661": ("77773182900084", False),
    "8482": ("77774937500120", False),
    "8512": ("52182610700018", False),
    "8513": ("26350014200538", False),
    "8515": ("77568030900363", False),
    "8516": ("18001012600019", False),
    "8517": ("77774299000073", False),
    "8518": ("77566659700072", False),
    "8519": ("13001501900024", True),
    "8520": ("75375957000108", False),
    "8521": ("77774937500021", False),
    "8523": ("22350001800013", True),
    "8552": ("33136655900010", False),
    "8554": ("77774934200146", False),
    "8555": ("52182610700018", False),
    "8557": ("57210489102100", False),
    "8558": ("38008597700045", False),
    "8559": ("44833705500033", False),
    "8561": ("17350001800028", False),
    "8594": ("77566669601724", False),
    "8595": ("38008597700045", False),
    "8597": ("33145778800403", False),
    "8600": ("23350001600040", False),
    "8601": ("34003552600029", False),
}

SIRET_BY_MES_AIDES_ID = {
    "recumV72JbZFxKxrW": "90321956600036",
    "recrN7PI9LqXvt7Fh": "90179408100041",
    "recgRCmRL2zUepF0f": "31221230100419",
    "rec8vxImKIBBIS8Et": "31221230100484",
    "rectak7apsCKFIHnA": "31221230101631",
    "recqoVfvsrXI7JuIu": "31221230100641",
    "rectovXpO4m98iJcp": "35183953500041",
    "rec7L8SquC8COd9HC": "67172009200053",
    "rec4a6jYCPlg672It": "30540659700024",
    "recYNgtbM7XKcAtyg": "06020060700020",
    "rectB3AT7qReRmoph": "50538491700033",
    "recWdXPVcoaBcPjtj": "82337006900036",
    "recF4ZQjCxzo1PWAU": "31221230100856",
    "recfaOuFmxk8agNFR": "75019087800033",
    "recb0DVsh1BHDIIvP": "83446405900015",
    "recSINE9Guf668brG": "35288746700020",
    "recgWz2I5rAppgDqD": "39825436700061",
    "recjhvImxmBuuWEw2": "59172050300059",
    "recEd7i6RZpoerIoq": "42141317000034",
    "recMqrMWPVslolDBk": "81414223800033",
    "rec1f15bH44aXACCt": "43393958400093",
    "recQJcv6QCHXQcRuT": "30211365900015",
    "recNMCU1bzipOzZhO": "84450936400015",
    "recAsAlg8096RCOM2": "43915648000030",
    "reczooFfKtChYokab": "51120804300022",
    "recaK1NoSuNtXhM6C": "35326655400024",
    "reciYvNpDVhB8dx3q": "42152567600035",
    "recoMc4XsvhxeqRsk": "59635009000012",
    "recwWaaTk9r4c7oMi": "37575046000012",
    "recUSgPat8Hfh0mdm": "42125856700096",
    "recLNojgGNDiiEfJV": "48432793700021",
    "rec2j5ctNsU1VNFu8": "33925599400024",
    "recdFB4z3SLsLKMoz": "84475208900020",
    "recdUWmZziHv5nugv": "55208783500153",
    "recHESULGyTRQzBfp": "55208783500153",
    "recNC48EnJ6JQVtF5": "52995866200031",
    "recnVK60hUl4LdR2D": "96222735100054",
    "recWhhKlhKv6lKZRk": "34903995800021",
    "recIv0ATBrqBQHF5Z": "40087606600038",
    "recu7iky0nUA3wlX3": "82140486000016",
    "recdKmZELJGP5kqNR": "82140486000016",
    "rec6xv9S5oQsn4WYm": "80440656900017",
    "recfawIuhAV6FIGjI": "55208783500153",
    "recit2JpFPvo3kGCB": "79525718700018",
    "recTeymk9L8bXLJJh": "42328835600029",
    "reckdIrMfjAt1wmEV": "77568497003032",
    "recWJw9uoW9a9NFT3": "37575046000079",
    "recP1poRkM4nZVU6s": "37575046000046",
    "recUcwJKXR6GcjfHZ": "42125856700039",
    "recqW8SO4TSmnWAdk": "43830580700028",
    "reccsN705WqjqUQab": "42125856700013",
    "rec7PmkuuAWyqufAK": "34911449600079",
    "rec2pR8nhE5t5LasK": "90428361100013",
    "recz7tomB5Avg6LQE": "52144292100032",
    "recnhYJB8ke68HEi2": "80746606500024",
    "recfPaSX97fQaZHIM": "88315268800015",
    "reclufipqCtNkA0Hk": "83511810000014",
    "rec9v5OJ0YXpCkGrV": "33429925200075",
    "recohG0UAOVVhUM6s": "39444675100023",
    "recBRTyBcq5w3oaCo": "79299611800024",
    "recgR4TCCsx7V1Bq2": "37789410000017",
    "recW1eY8FsjRohTSN": "02578023000022",
    "recxkiJkwzWbnMRYu": "33429925200067",
    "rec4deGr9MkHZThld": "82314869700027",
    "recvxx38geJRDcCEH": "52904723500021",
    "recXwT2yXOamCQ0kE": "40387269000033",
    "recbcLHCH4JSh4XJJ": "53388692500023",
    "recMYL5XokrUtVOZd": "83002426100026",
    "recZM68QtXcxFuJSc": "80960788000014",
    "recS37zQprJr83Mn5": "80994652800027",
    "rec6djnXDmyHWD5A0": "82197861600026",
    "recNixoGUAJOEj8oK": "38142759000017",
    "recZtUX4h3uB0iJ1X": "85169150100015",
    "recFF621Te7Bs0lv4": "44935731800020",
    "rec9inMnCJKLh9I3F": "53485228000013",
    "rechu4URGOKRedxcT": "41280524400032",
    "recMrITulVcvRDNI9": "02578023000055",
    "rec9SxOVQh5CaqAZM": "42145376200021",
    "recauTFe8n5OfyCkv": "39444675100015",
    "rechTv55BobprZakH": "41175371800039",
    "recM4PMUayeQKs8lU": "80960788000030",
    "reck8pYzQYCWhPMrq": "83242312300013",
    "recEEjIoeKopLZWPk": "75093703900014",
    "recd5VuiLJevMuu9p": "47936035600014",
    "recJKgtxQavCrjwX1": "43767929300013",
    "recMD43wzQ4KbufVT": "82966921700046",
    "reccuYaSQGKtyENeP": "38890407000017",
    "recwGrgso2EXZjk8S": "32840109600016",
    "recEYozDrQss59OdK": "35380723300013",
    "recEO3WAZ79Jct4bE": "64980253500017",
    "recavC8eKAWtoTyHX": "81487308900027",
    "recOoa4A5eZbYWVNC": "79529285300020",
    "recXukX3VQOfnzkbJ": "79459492900026",
    "recLy0ILoswYBjIET": "53842533100013",
    "recXQiqEsz9XcNMB9": "52325744200021",
    "recv0WJonpakPbOPn": "79200272700024",
    "recBWPzOPa8DjT0wN": "79200272700024",
    "recTWocOIBixAcmcZ": "32254751400024",
    "recwwxEns20GEAIY6": "47856939500013",
    "recvzvVdNY5S93wmX": "82996142400019",
    "recD5bFuxtZePq9uJ": "39812654000010",
    "recyqyWZOcoUB7Adc": "51956805900017",
    "recv5xmj1PLVmZubh": "71820420900016",
    "recW2UCgTuO7ZflmM": "53228976600018",
    "rec8qCmTge6UH7wME": "81414223800033",
    "reczLOorjjtpttNc4": "30185457600024",
    "rec0EgY1K2K8jnuK0": "82245456700030",
    "rec4a8yYPgcT6e6pD": "79008521100049",
    "recxt0PPbq4WYOhUz": "43986127900016",
    "recNN0rviAj3DtJJa": "89005395200010",
    "recWluqep1AZ0cBzv": "50538491700017",
    "recAbA4gDBxonZLHn": "51982159900015",
    "recQYg93pMId19MdW": "75080730700012",
    "recRl9Z4D54wyD1Ms": "49483883200017",
    "recV4jweeP4F2pMwv": "31818695400018",
    "recJdtio0dztkTbnp": "49751668200018",
    "recx9X03Ecu3wC5op": "87970393200019",
    "rec4nwsAXWHsBx6ve": "49327669500019",
    "recvJLjrVWJCAMqIx": "30946926000017",
    "reczWJi3nfbEYqOdT": "41173709100040",
    "recvNNBuIIGsKKHGj": "41753346000016",
    "recbrzj8Lp7Og31en": "78971138900021",
    "recghBeaeMFBR6a52": "32698064600045",
    "recfYWKuAM6qksMAM": "82652013200026",
    "rec4LQ7MiDX7LHi7o": "81282200500029",
    "recI8tAERpjGuscnE": "00672006400069",
    "recaEKivLuSARPRZU": "53229553200016",
    "recxKIgcrZKyeWOis": "77805921200036",
    "recq1g4vVn1WsFXM6": "79434591800013",
    "recWwYjayqBOk2R20": "33429925200042",
    "rec39OosuNBnEFMoU": "44054935000021",
    "recWu55qUx0SGgMS9": "40011326200010",
    "recjhy5nJSdiTAVz5": "75273349300015",
    "rec3iaNsyjWrFDMUI": "32832117900017",
    "reczLk913UTkJXREG": "75401249000019",
    "recXPaOHfKgT0Afr3": "37904113000012",
    "recA4yZu8CM30Zo8I": "00732029400023",
    "reckuARsvEQU4j9cj": "33003506400022",
    "recd5H79IOiLU8dn2": "39986478400018",
    "recGL75vZzm12ikyZ": "41039155100034",
    "recmDfiNsIeAKpt74": "47897081700019",
    "recExC2uwTElTUKxF": "32669935200026",
    "recNesHwLFE3l81ug": "82335067300013",
    "recTJPocfw1jRfCnW": "32793343800050",
    "rec6pccXWg7aYDkGo": "02578023000030",
    "recTLaZqJPWH8uwd2": "39812654000044",
    "rec2oxVTl3hdER7xd": "51936229700011",
    "recBKYzq8iAkkgW4g": "79383187600016",
    "recRDBMgI0IclOiPY": "72850249300022",
    "rec4ceJc7TmSic1PC": "79924134400016",
    "recG7124c4ew7l9Mf": "81875681900012",
    "rec0kMqw8UTiBDC4Q": "49418811300018",
    "reclRhfbmgD0xCrVJ": "33357512400024",
    "rect6cq1eXYKm5fxk": "47992529900014",
    "rectoAXRbQekTmwvz": "82006013500010",
    "rec3cBxvsX4xafSH6": "06020060700079",
    "recqqDfidM56o6G14": "88920404600037",
    "rec0vmzuHugawqCJW": "80844296600012",
    "rectPNdkWXQK6ZoJR": "51692016200026",
    "rec4uKOWiXOQbVx8z": "80077556100015",
    "rec1A1m9NRx8MEpVE": "00672006400051",
    "recOewIybtadCHJfx": "30121111600035",
    "recjztVi6sHqLbLOB": "81853793800016",
    "rectSdrXU5iAt3SrW": "48430667500014",
    "recWqkXiG01VYhwT8": "79958131900024",
    "recGNjE2BqcNif7Cs": "69172079100017",
    "recAbZJaKvsfATiIm": "81967536400015",
    "reclpKqnAw4qh0BBh": "35288746700087",
    "recNeh0X9ZnEgqk7L": "42218336800014",
    "rec4d4TKzfVZqcnCU": "77839830500087",
    "recofSSJ8u8W8YCOc": "83837479100013",
    "recKcD2GAkA3dUaDy": "52801082000025",
    "recby70hQfBxaXsow": "33205160600017",
    "recm5DRzKmgLfsWUg": "38080485600017",
    "recsdX0EFnuvHsSys": "50792593100028",
    "rec0dWCxBEsFjuImj": "81128090800021",
    "reciZC8rZOshDScgE": "32414497100011",
    "reculP5q0Ha7FXiii": "67688031300033",
    "recjZLcy87WhQdsAq": "89855506500017",
    "recaFoHEwwyZdkEYk": "84295394500024",
    "recZClPVtsLIaONuG": "88920406100028",
    "recqbqiPhSjvj4xSU": "89086755900027",
    "recxhRv4plruFPAvf": "45008435500020",
    "reck8JkkweKEoB7QS": "43798317400032",
    "recz643S9DqlYV2JV": "38816502900017",
    "recOLl8hQyxLmnQJU": "79245631100036",
    "rec8voZrxwFtBO28E": "78813992100027",
    "recTOMZIEW74n3K1I": "78813992100084",
    "rec4LJF4QTpNFx3hZ": "00672006400036",
    "recX4vtr8ppnCUL6U": "33150100700016",
    "recqkEIWmfZrdF0qD": "79472781800013",
    "rec8MX6l8g9ezIuwI": "79787338700014",
    "rec4LmYjdfUTC6AjG": "34921262100016",
    "recMcEPEtdj3pP1Vr": "41813263500016",
    "rec51ppO1NGN1jmqa": "32262335600019",
    "rect4wwXbqlxih8a5": "52792124100024",
    "recy1MzBQOJKGUwgj": "78813992100050",
    "recchnLIS7kJMreox": "78813992100076",
    "recmqNtAc7JBSQ1bY": "50128970600027",
    "recultA0S9Oo5FAmo": "30457621801345",
    "rec5i9eWC6YdEo2tq": "45275269400029",
    "reczZo5y0Mgo6Kk1v": "40411783000046",
    "recOvz7iPzzKJclSt": "80292667500033",
    "recgucxcDnGi2Knj0": "33915147400022",
    "recCxQPrV02LqgIUq": "51303040300036",
    "recp7JkDEb4GJzOPO": "43961599800010",
    "recY6BhZd8aXcVACX": "53336670400013",
    "recl5wG6ZFLsbRPiM": "45298591400020",
    "recn8075oVGPHYAjN": "82173998400010",
    "rectuXrlTuTujuZJ8": "51002242900037",
    "recVqYvFXQSZRBOts": "41961387200011",
    "recurCp1RQMeESVxj": "39459749600014",
    "rec9bv9QGCDoz601S": "52261414800024",
    "rec9UxnmfVNzQKL6g": "78813992100092",
    "recOj3h0EGLwHD654": "40221232800015",
    "rec5SKCvmmNcm3evO": "80831833100010",
    "recEAu1DXXax0hjrQ": "53127068400024",
    "rechZGs1G4Vm2Tk3k": "40411783000079",
    "recHXaNZbQGsoVfwW": "47995044600027",
    "recC7wvjGhclB7VNu": "83425334600037",
    "rectfHuGTDEaVauuV": "32288196200011",
    "rec3rFDeZUD1PRFlp": "32288196200078",
    "recCqcLX5UUeDrAjN": "52995866200056",
    "recdgfizP9d6RxAlb": "34595006700032",
    "recPubYkJpvwoPJ5A": "87320016600049",
    "recUPvv4VTXZfsAmQ": "34595006700032",
    "recbxjziXyPJ6sieK": "75850037500095",
    "recMQyas0aAXinPTW": "78954107500022",
    "rec3E5ruj8wa5AiGg": "42826082200054",
    "recUPLJg4OGnzOXJa": "83085265300021",
    "recnq0pTvlWgwwEru": "77557795000691",
    "rec9k4S0EqJgaCT03": "53043381200019",
    "recSxTrluhTaDQwDP": "89382472200019",
    "recvGUtwuF6sP5ZZT": "90860504100015",
    "recAz5u27ivwn1x02": "51121275500017",
    "recfOCY27iowCPdAu": "31221230100567",
    "rec8guHLOPyNO8F39": "77568879900078",
    "recDUiGfy4aILe1xd": "38358921500011",
    "recz1vVq8qEWSvm6k": "31208709100020",
    "recdeu5UmiAQ1jNxq": "45160906900013",
    "recg2BUCJeWu2tFEN": "41927719900024",
    "recq8p5cg8jCNKQlg": "32614645300021",
    "rec4Wowe35S7fia2O": "50168500200013",
    "recXpGJYfoK06WDLK": "43847019700023",
    "rec8WQxlWzGKwgwLx": "84284043100030",
    "rec1QFp4ZDHnpMxDV": "40046865800010",
    "rec2k2TF9c2pWYoJl": "82173998400010",
    "recQ1nYi3jTTOCA4T": "84162943900016",
    "recp1gkc77B9BdEZv": "32288196200052",
    "recUKUNJIAReqs26m": "52359317600028",
    "recv8CtVRSOuzmuh2": "44148850900015",
    "recSt8gbfgDwYXVes": "94715157700022",
    "recu1gWcJWOz4QyNE": "33883920200110",
    "reciiZQvloc4xMmiu": "40149469500018",
    "recCxBRJa35rAozVU": "41963860600014",
    "rec8ldDUZAzaTGpL7": "34177423000021",
    "rechYPSJyDIcoSzjS": "57980260400010",
    "recTGJEnJSTU5D8Hh": "49863997000033",
    "recQDo7IKu7hcSHTv": "49977050100017",
    "rec9Ven9pq1YKKMWK": "79472781800021",
    "recmcyLNB0sWNBRKP": "41963860600048",
    "rec5miZW9VVhRR4MD": "52995866200023",
    "recbi03TTpQMOR9NZ": "61622046300015",
    "recvpOA8SUeDE8Au2": "67172009200038",
    "recHPHBD7xqEBefrx": "34911449600046",
    "recvHiGM0xfvxADeF": "32288196200045",
    "rec0FfCTvBvGrQf9F": "95002690600020",
    "rec6dvizowbX8ZygJ": "83936548300016",
    "recF0RQpl9pCMPtg7": "30436932500028",
    "recS3WyeVGDZn4Olo": "37575046000053",
    "recUFRSFg6axGhbC5": "85550015300025",
    "recrorJkks6t1x0bU": "43879944700018",
    "recKur0XLmdYVqB3t": "78014400200026",
    "recKPGTOZa5aqx96l": "35290366000061",
    "recNvnQWvBMSJi9wM": "55642016400023",
    "recCBzqtr81tZEL39": "82068710100023",
    "recQ1HWoHjyXDrLlD": "41963860600055",
    "recjb8KKipSIRfxre": "33883920200037",
    "rec9VGckeRzaOoZ1h": "80741454500010",
    "reccgN9jnNUC0ebLG": "32599529800024",
    "recUlhdii52rTLrnb": "49924393900034",
    "recFNM0Cmhl7dBAgO": "42152567600050",
}
