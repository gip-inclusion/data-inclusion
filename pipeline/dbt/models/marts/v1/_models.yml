version: 2

models:
  - name: marts__structures_v1
    config:
      indexes:
        - columns: ['source']
    data_tests:
      - model_validate:
          arguments:
            model_class: data_inclusion.schema.v1.Structure
            where: _is_valid
    columns:
      - name: id
        data_type: text
        constraints:
          - type: primary_key
      - name: siret
        data_type: text
        data_tests:
          - dbt_utils.relationships_where:
              arguments:
                to: ref('stg_sirene__stock_etablissement')
                field: siret
                to_condition: etat_administratif_etablissement = 'actif'
      - name: nom
        data_type: text
      - name: commune
        data_type: text
      - name: code_postal
        data_type: text
      - name: code_insee
        data_type: text
      - name: adresse
        data_type: text
      - name: complement_adresse
        data_type: text
      - name: longitude
        data_type: float
      - name: latitude
        data_type: float
      - name: telephone
        data_type: text
      - name: courriel
        data_type: text
      - name: site_web
        data_type: text
      - name: description
        data_type: text
      - name: source
        data_type: text
        constraints:
          - type: not_null
      - name: date_maj
        data_type: date
      - name: lien_source
        data_type: text
      - name: horaires_accueil
        data_type: text
      - name: accessibilite_lieu
        data_type: text
      - name: reseaux_porteurs
        data_type: text[]
      - name: _cluster_id
        data_type: text
      - name: _has_valid_address
        data_type: boolean
        constraints:
          - type: not_null
      - name: _has_pii
        data_type: boolean
        constraints:
          - type: not_null
      - name: _in_opendata
        data_type: boolean
        constraints:
          - type: not_null
      - name: _is_valid
        data_type: boolean
        constraints:
          - type: not_null
      - name: _is_closed
        data_type: boolean
        constraints:
          - type: not_null

  - name: marts__structures_reseaux_porteurs_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: structure_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__structures_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null

  - name: marts__services_v1
    config:
      indexes:
        - columns: ['structure_id']
        - columns: ['source']
        - columns: ['modes_accueil']
          type: gin
        - columns: ['thematiques']
          type: gin
        - columns: ['CAST(ST_MakePoint(longitude, latitude) AS geography(geometry, 4326))']
          type: gist
    data_tests:
      - model_validate:
          arguments:
            model_class: data_inclusion.schema.v1.Service
            where: _is_valid
    columns:
      - name: id
        data_type: text
        constraints:
          - type: primary_key
      - name: structure_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__structures_v1')
            to_columns: [id]
      - name: source
        data_type: text
        constraints:
          - type: not_null
      - name: nom
        data_type: text
      - name: conditions_acces
        data_type: text
      - name: description
        data_type: text
      - name: type
        data_type: text
      - name: thematiques
        data_type: text[]
      - name: frais
        data_type: text
      - name: frais_precisions
        data_type: text
      - name: publics
        data_type: text[]
      - name: publics_precisions
        data_type: text
      - name: commune
        data_type: text
      - name: code_postal
        data_type: text
      - name: code_insee
        data_type: text
      - name: adresse
        data_type: text
      - name: complement_adresse
        data_type: text
      - name: longitude
        data_type: float
      - name: latitude
        data_type: float
      - name: horaires_accueil
        data_type: text
      - name: lien_source
        data_type: text
      - name: telephone
        data_type: text
      - name: courriel
        data_type: text
      - name: contact_nom_prenom
        data_type: text
      - name: date_maj
        data_type: date
      - name: lien_mobilisation
        data_type: text
      - name: mobilisable_par
        data_type: text[]
      - name: mobilisation_precisions
        data_type: text
      - name: modes_accueil
        data_type: text[]
      - name: modes_mobilisation
        data_type: text[]
      - name: zone_eligibilite
        data_type: text[]
      - name: volume_horaire_hebdomadaire
        data_type: float
      - name: nombre_semaines
        data_type: integer
      - name: score_qualite
        data_type: float
      - name: _has_valid_address
        data_type: boolean
        constraints:
          - type: not_null
      - name: _extra
        data_type: jsonb
      - name: _has_pii
        data_type: boolean
        constraints:
          - type: not_null
      - name: _in_opendata
        data_type: boolean
        constraints:
          - type: not_null
      - name: _is_valid
        data_type: boolean
        constraints:
          - type: not_null

  - name: marts__services_mobilisable_par_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: service_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__services_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null

  - name: marts__services_modes_accueil_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: service_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__services_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null

  - name: marts__services_modes_mobilisation_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: service_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__services_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null

  - name: marts__services_publics_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: service_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__services_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null

  - name: marts__services_thematiques_v1
    config:
      indexes:
        - columns: ['value']
    columns:
      - name: service_id
        data_type: text
        constraints:
          - type: not_null
          - type: foreign_key
            to: ref('marts__services_v1')
            to_columns: [id]
      - name: value
        data_type: text
        constraints:
          - type: not_null
