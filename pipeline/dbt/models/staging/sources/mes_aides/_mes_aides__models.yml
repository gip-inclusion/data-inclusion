version: 2

models:
  - name: stg_mes_aides__garages
    columns:
      - name: adresse
        data_tests:
          - not_null:
              config:
                error_if: ">50"
          - dbt_utils.not_empty_string
      - name: cree_le
      - name: cree_par
      - name: criteres_eligibilite
        data_tests:
          - dbt_utils.at_least_one
          - dbt_utils.not_empty_string
      - name: departement__code
        data_tests:
          - not_null:
              config:
                error_if: ">5"
          - relationships:
              arguments:
                to: ref('stg_decoupage_administratif__departements')
                field: code
      - name: departement__nom
        data_tests:
          - not_null:
              config:
                error_if: ">5"
          - dbt_utils.not_empty_string
      - name: email
      - name: en_ligne
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]
      - name: id
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
          - relationships:
              arguments:
                to: ref('stg_mes_aides__garages__besoins')
                field: garage_id
          - relationships:
              arguments:
                to: ref('stg_mes_aides__garages__services')
                field: garage_id
          - relationships:
              config:
                error_if: ">5"
              arguments:
                to: ref('stg_mes_aides__garages__types_de_vehicule')
                field: garage_id
      - name: mis_a_jour_le
        description: |
          Date of last validation, set by mes_aides.fr team.
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              config:
                error_if: ">100"
              arguments:
                expression: "<= modifie_le"
      - name: modifie_le
        description: |
          Date of last row modification, generated by airtable.
        data_tests:
          - not_null
      - name: nom
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: partenaire
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: region__code
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_decoupage_administratif__regions')
                field: code
      - name: region__nom
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: ville__code_insee
        data_tests:
          - not_null:
              config:
                error_if: ">20"
          - relationships:
              arguments:
                to: ref('stg_decoupage_administratif__communes')
                field: code
      - name: telephone
        data_tests:
          - dbt_utils.not_empty_string
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.5
      - name: type
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - Garage (offre solidaire)
                  - Atelier d''auto-réparation
                  - Self garage
                  - Service solidaire (mise à disposition)
                  - Loueur
                  - Transport à la demande
                  - Garage solidaire
      - name: url
        data_tests:
          - dbt_utils.at_least_one
          - dbt_utils.not_empty_string
      - name: ville__code_postal
        data_tests:
          - not_null:
              config:
                error_if: ">20"
          - dbt_utils.not_empty_string
      - name: ville__nom
        data_tests:
          - not_null:
              config:
                error_if: ">20"
          - dbt_utils.not_empty_string


  - name: stg_mes_aides__garages__besoins
    columns:
      - name: garage_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__garages')
                field: id
      - name: item
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - Accompagnement personnalisé à la mobilité
                  - Acheter ou louer un véhicule
                  - Atelier pédagogique
                  - Covoiturage & autopartage
                  - Réparer votre véhicule
                  - Transport à la demande
      - name: categorie
        description: |
          As defined by mes_aides.fr.
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - Transport
                  - Mobilité

  - name: stg_mes_aides__garages__services
    columns:
      - name: garage_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__garages')
                field: id
      - name: item
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - location
                  - auto-école sociale
                  - achat
                  - atelier pédagogique
                  - réparation

  - name: stg_mes_aides__garages__types_de_vehicule
    columns:
      - name: garage_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__garages')
                field: id
      - name: item
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - moto
                  - scooter
                  - trottinette
                  - vélo & vae
                  - voiture
                  - voiture sans permis

  - name: stg_mes_aides__permis_velo
    columns:
      - name: id
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
      - name: modifie_le
        data_tests:
          - not_null
      - name: zone_geographique
        data_tests:
          # FIXME: to remove once the data is clean
          # - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              config:
                severity: error
                error_if: ">20"
                warn_if: ">0"

              arguments:
                values:
                  - 'Échelle communale'
                  - 'Échelle intercommunale'
                  - 'Échelle régionale'
                  - 'Échelle départementale'
                  - 'France métropolitaine'
                  - 'Échelle nationale'
  - name: stg_mes_aides__permis_velo__types
    columns:
      - name: service_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__permis_velo')
                field: id
      - name: value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              config:
                severity: error
                error_if: ">20"
                warn_if: ">0"
              arguments:
                values: ['Aide financière', 'Prestation', 'Accompagnement']
  - name: stg_mes_aides__permis_velo__natures
    columns:
      - name: service_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__permis_velo')
                field: id
      - name: value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              arguments:
                values:
                  - Somme d''argent
                  - Prise en charge partielle
                  - Tarif préférentiel
                  - Prise en charge totale
                  - Prêt remboursement
                  - Facilitation de paiement
                  - Prise en charge partielle ou totale
  - name: stg_mes_aides__permis_velo__methodes
    columns:
      - name: service_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__permis_velo')
                field: id
      - name: value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              config:
                severity: error
                error_if: ">20"
                warn_if: ">0"
              arguments:
                values:
                  - 'La démarche nécessite un passage ou une prise de contact directe avec votre organisme'
                  - 'La démarche nécessite une connexion sur le site de votre organisme'
                  - 'La démarche peut être faite par mail'
  - name: stg_mes_aides__permis_velo__liaisons_besoins
    columns:
      - name: service_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_mes_aides__permis_velo')
                field: id
      - name: value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              config:
                severity: error
                error_if: ">20"
                warn_if: ">0"
              arguments:
                values:
                  - "Financer mon permis"
                  - "Financer mes trajets"
                  - "Financer le carburant"
                  - "Financer mon BSR"
                  - "Financer l''achat d''un véhicule"
                  - "Déménager"
                  - "Transports en commun"
                  - "Transport à la demande"
                  - "Réparer ma voiture"
                  - "Louer un vélo électrique"
                  - "Ma voiture"
                  - "Mon vélo électrique"
                  - "Mon scooter"
                  - "Acheter un vélo électrique"
                  - "Acheter ou louer un vélo"
                  - "Acheter ou louer une voiture"
                  - "Accéder au permis de conduire"
                  - "Partir à l''étranger"
                  - "Handicap & mobilité"
                  - "Trouver une alternance"
                  - "Trouver un contrat d''apprentissage"
                  - "Préparer une candidature"
                  - "Rédiger une lettre de motivation ou un CV"
                  - "Préparer une candidature"
                  - "Rédiger une lettre de motivation ou un CV"
                  - "Devenir locataire"
                  - "Financer mon loyer"
                  - "Faire des travaux"
                  - "Trouver un logement social"
                  - "Financer une formation"
                  - "Faire garder mes enfants"
                  - "Trouver une formation"
                  - "Rémunération pendant la formation"
                  - "Reconversion"
                  - "Accompagnement personnalisé à la mobilité"
                  - "Créer ou reprendre une entreprise"
                  - "Réparer mon vélo"
                  - "Acheter ou louer une voiture sans permis, \"Scooter, trottinette...\""
