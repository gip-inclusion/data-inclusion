version: 2

models:
  - name: stg_ma_boussole_aidants__structures__services
    columns:
      - name: id_structure
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_ma_boussole_aidants__structures')
                field: id_structure
      - name: is_distanciel
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: [true, false]
      - name: id_sous_thematique_solutions
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_ma_boussole_aidants__solutions')
                field: code

  - name: stg_ma_boussole_aidants__structures__situations
    columns:
      - name: id_structure
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_ma_boussole_aidants__structures')
                field: id_structure
      - name: id_situation
        data_tests:
          - not_null
      - name: nom_situation
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: id_profil
        data_tests:
          - not_null

  - name: stg_ma_boussole_aidants__structures
    columns:
      - name: id_structure
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
      - name: adresse__code_postal
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: adresse__latitude
        data_tests:
          - not_null
      - name: adresse__longitude
        data_tests:
          - not_null
      - name: adresse__ligne_adresse
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: age_max
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 150
      - name: age_min
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 150
      - name: departement__code_departement
        data_tests:
          - not_null:
              config:
                error_if: ">200"
          - relationships:
              arguments:
                to: ref('stg_decoupage_administratif__departements')
                field: code
      - name: email
        data_tests:
          - dbt_utils.not_empty_string
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.3
      - name: last_modified_date
        data_tests:
          - not_null
      - name: nom_structure
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: rayon_action__nom_rayon_action
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['départemental', 'communal', 'local']
      - name: site_web
        data_tests:
          - dbt_utils.not_empty_string
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.3
      - name: structure_mere__siret
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: telephone_1
        data_tests:
          - dbt_utils.not_empty_string
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.5
      - name: id_type_structure
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
          - accepted_values:
              arguments:
                values:
                  - 15  # CCAS
                  - 53  # Maison Départementale de l'Autonomie
                  - 127 # Maison Départementale des Solidarités
      - name: description_structure
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: ville__code_commune
        data_tests:
          - not_null:
              config:
                error_if: ">500"
          - relationships:
              config:
                error_if: ">500"
              arguments:
                to: ref('stg_decoupage_administratif__communes')
                field: code
      - name: ville__nom_ville

  - name: stg_ma_boussole_aidants__solutions
    columns:
      - name: code
        data_tests:
          - unique
          - not_null
      - name: label
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: description
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
