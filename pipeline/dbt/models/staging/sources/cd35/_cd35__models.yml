version: 2

models:
  - name: stg_cd35__organisations
    columns:
      - name: adresse
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: code_insee
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: code_postal
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: commune
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: complement_adresse
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: courriel
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: date_maj
        data_tests:
          - dbt_utils.not_constant
      - name: horaires_ouvertures
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string:
              config:
                severity: warn
      - name: id
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
      - name: latitude
        data_tests:
          - dbt_utils.not_constant
      - name: lien_source
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: longitude
        data_tests:
          - dbt_utils.not_constant
      - name: nom
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: presentation_detail
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: sigle
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: site_web
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string
      - name: telephone
        data_tests:
          - dbt_utils.not_constant
          - dbt_utils.not_empty_string

  - name: stg_cd35__organisations__profils
    columns:
      - name: structure_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_cd35__organisations')
                field: id
      - name: raw_value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: value
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_cd35__profils')
                field: value

  - name: stg_cd35__organisations__thematiques
    data_tests:
      - unique:
          arguments:
            column_name: structure_id || '--' || raw_index
    columns:
      - name: structure_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_cd35__organisations')
                field: id
      - name: raw_value
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: raw_index
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              arguments:
                min_value: 1
                max_value: 100
      - name: value
        data_tests:
          - dbt_utils.not_null_proportion:
              arguments:
                at_least: 0.3
          - relationships:
              arguments:
                to: ref('stg_cd35__thematiques')
                field: value

  - name: stg_cd35__profils
    columns:
      - name: raw
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
      - name: value
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string

  - name: stg_cd35__thematiques
    columns:
      - name: raw
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
      - name: value
        data_tests:
          - unique
          - not_null
          - dbt_utils.not_empty_string
