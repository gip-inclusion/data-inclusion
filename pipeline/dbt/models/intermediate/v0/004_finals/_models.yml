version: 2

models:
  - name: int__erreurs_validation
    config:
      indexes:
        - columns: ['_di_surrogate_id']
        - columns: ['schema_version']
        - columns: ['resource_type']
    columns:
      - name: _di_surrogate_id
        data_tests:
          - not_null
          - relationships:
              config:
                where: resource_type = 'structure'
              arguments:
                to: ref('int__structures')
                field: _di_surrogate_id
          - relationships:
              config:
                where: resource_type = 'service'
              arguments:
                to: ref('int__services')
                field: _di_surrogate_id
      - name: source
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: id
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: loc
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: input
      - name: schema_version
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - v0
                  - v1
      - name: resource_type
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - service
                  - structure
      - name: model_class
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - data_inclusion.schema.v0.Service
                  - data_inclusion.schema.v0.Structure
                  - data_inclusion.schema.v1.Service
                  - data_inclusion.schema.v1.Structure
      - name: msg
        data_tests:
          - not_null

  - name: int__services
    config:
      indexes:
        - columns: ['_di_surrogate_id']
          unique: true
    columns:
      - name: zone_diffusion_code
        data_tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.not_empty_string
          - dbt_utils.not_constant
          - dbt_utils.expression_is_true:
              config:
                severity: warn
              arguments:
                expression: "!~ '^(751|693|132)'"
          - relationships:
              # TODO(vmttn): prevent false codes from being propagated downstream
              # and set back severity to error
              config:
                severity: warn
                where: "zone_diffusion_type = 'region'"
              arguments:
                to: ref('stg_decoupage_administratif__regions')
                field: code
          - relationships:
              config:
                severity: warn
                where: "zone_diffusion_type = 'departement'"
              arguments:
                to: ref('stg_decoupage_administratif__departements')
                field: code
          - relationships:
              config:
                severity: warn
                where: "zone_diffusion_type = 'epci'"
              arguments:
                to: ref('stg_decoupage_administratif__epcis')
                field: code
          - relationships:
              config:
                severity: warn

                where: "zone_diffusion_type = 'commune'"
              arguments:
                to: ref('stg_decoupage_administratif__communes')
                field: code
  - name: int__structures

  - name: int__criteres_qualite
    description: |
      Quality criteria scorings for services from all sources.
      Each row holds a single criterion score for a service.
      For a given service, there is as many rows as defined criteria.
      A null score means the criterion is not applicable to the service.
      Scoring is done by data-inclusion-schema scoring api in PL/Python.
    columns:
      - name: service_id
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('int__union_services')
                field: _di_surrogate_id
      - name: nom_critere
        description: Name of the criterion.
        data_tests:
          - not_null
          - dbt_utils.not_empty_string
      - name: score_critere
        description: |
          Score for the given criterion and the given service, between 0 and 1.
      - name: score_ligne
        data_tests:
          - not_null
          - dbt_utils.not_constant
          - dbt_utils.accepted_range:
              arguments:
                min_value: 0
                max_value: 1
      - name: schema_version
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - v0
                  - v1
